#!/bin/bash

# --- Configurations ---
TERMUX_ROOT="termux-root-packages"
CACHE_FILE="$HOME/.expkg_cache"
LOG_FILE="$HOME/.expkg_log"
CONFIG_FILE="$HOME/.expkg_conf"
REPO_LIST_FILE="$HOME/.expkg_repos"

# --- Colors ---
RED="\033[31m"
GREEN="\033[32m"
YELLOW="\033[33m"
BLUE="\033[34m"
CYAN="\033[36m"
RESET="\033[0m"
BOLD="\033[1m"

# --- Helper Functions ---
function log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >>"$LOG_FILE"
}

function print_verbose() {
    echo -e "${YELLOW}[INFO]${RESET} $1"
    log "[INFO] $1"
}

function print_success() {
    echo -e "${GREEN}[SUCCESS]${RESET} $1"
    log "[SUCCESS] $1"
}

function print_error() {
    echo -e "${RED}[ERROR]${RESET} $1"
    log "[ERROR] $1"
}

# --- Caching ---
function cache_packages() {
    print_verbose "Caching package list locally"
    curl -s -H "Accept: application/vnd.github.v3+json" "https://api.github.com/repos/termux/termux-root-packages/contents/packages" |
        jq -r '.[] | select(.type == "dir") | .name' >"$CACHE_FILE"
    print_success "Package list cached"
}

function clean_cache() {
    print_verbose "Cleaning package cache"
    rm -f "$CACHE_FILE"
    print_success "Package cache cleaned"
}

function read_cache() {
    if [[ ! -f $CACHE_FILE ]]; then
        print_error "Package cache is empty or not found. Run 'expkg cache' to refresh."
        exit 1
    fi
    cat "$CACHE_FILE"
}

# --- Dependency Management ---
function install_dependencies() {
    local deps="$1"
    if [[ -z $deps ]]; then
        print_error "No dependencies provided for installation"
        return 1
    fi

    print_verbose "Installing dependencies..."
    for dep in $(echo "$deps" | jq -r '.[].name'); do
        print_verbose "Installing $dep"

        local manager="$(echo "$dep" | grep -o '^[^:]*')"
        local package_name="$(echo "$dep" | sed 's/^[^:]*://')"

        case "$manager" in
            pip)
                print_verbose "Using pip to install $package_name"
                pip install "$package_name"
                ;;
            npm)
                print_verbose "Using npm to install $package_name"
                npm install "$package_name"
                ;;
            pacman)
                print_verbose "Using pacman to install $package_name"
                pacman -S "$package_name" --noconfirm
                ;;
            apt)
                print_verbose "Using apt to install $package_name"
                apt install "$package_name" -y
                ;;
            pkg)
                print_verbose "Using pkg to install $package_name"
                pkg install "$package_name" -y
                ;;
            *)
                print_error "Unsupported package manager '$manager' for package '$package_name'"
                return 1
                ;;
        esac
    done
    print_success "Dependencies installed"
}

# --- Custom Repository Management ---
function validate_repo_manifest() {
    local manifest="$1"

    # Check if file contains @define-repo
    if ! grep -q "^@define-repo" <<<"$manifest"; then
        print_error "Invalid repository manifest. Missing '@define-repo'."
        return 1
    fi

    # Check for essential keys <$name>, <$reference>, <$description>
    if ! grep -q "<\\$name>" <<<"$manifest"; then
        print_error "Invalid repository manifest. Missing '<$name>'."
        return 1
    fi
    if ! grep -q "<\\$reference>" <<<"$manifest"; then
        print_error "Invalid repository manifest. Missing '<$reference>'."
        return 1
    fi
    if ! grep -q "<\\$description>" <<<"$manifest"; then
        print_error "Invalid repository manifest. Missing '<$description>'."
        return 1
    fi

    # Check for dependencies block
    if ! grep -q "%dependencies {" <<<"$manifest"; then
        print_verbose "No dependencies block found; proceeding without it."
        return 0
    fi

    # Validate each dependency category (pip, npm, etc.)
    dependencies=$(sed -n '/%dependencies {/,/}/p' <<<"$manifest" | sed '/%dependencies {/{h;d};H;$!d;g')
    if [[ ! "$dependencies" =~ "<pip>" ]] && [[ ! "$dependencies" =~ "<npm>" ]] && \
       [[ ! "$dependencies" =~ "<pacman>" ]] && [[ ! "$dependencies" =~ "<apt>" ]] && \
       [[ ! "$dependencies" =~ "<pkg>" ]]; then
        print_verbose "No recognized dependency types found. Proceeding."
    fi

    print_success "Repository manifest validated."
    return 0
}

function add_repository() {
    local repo_url="$1"
    if [[ -z $repo_url ]]; then
        print_error "Repository URL is required."
        return 1
    fi

    print_verbose "Fetching repository manifest from $repo_url"
    repo_manifest=$(curl -s "$repo_url/list.pkgrepo")
    if [[ -z $repo_manifest ]]; then
        print_error "Failed to fetch 'list.pkgrepo'. Ensure the file exists at the repository root."
        return 1
    fi

    validate_repo_manifest "$repo_manifest"
    if [[ $? -ne 0 ]]; then
        print_error "Repository manifest validation failed."
        return 1
    fi

    echo "$repo_manifest" >>"$REPO_LIST_FILE"
    print_success "Repository added successfully."

    # Fetch dependencies
    dependencies=$(sed -n '/%dependencies {/,/}/p' <<<"$repo_manifest" | sed '/%dependencies {/{h;d};H;$!d;g' | sed 's/<.*>\s*//g')
    if [[ -n $dependencies ]]; then
        print_verbose "Dependencies found for this repository:"
        echo "$dependencies" | tr '\n' ' ' | xargs -n 1 echo -e "${CYAN}â€¢${RESET} " 
        echo

        read -p "Do you want to install all dependencies? (y/n): " install_deps
        if [[ "$install_deps" =~ ^[Yy]$ ]]; then
            install_dependencies "$dependencies"
        fi
    fi
}

function list_repositories() {
    if [[ ! -f $REPO_LIST_FILE ]]; then
        print_error "No repositories found. Add one using 'expkg add <repo_url>'."
        return 1
    fi
    cat "$REPO_LIST_FILE"
}

# --- Package Operations ---
function install_package() {
    local pkg_name="$1"
    if [[ -z $pkg_name ]]; then
        print_error "Package name is required for installation"
        return 1
    fi

    local pkg_dir="$TERMUX_ROOT/packages/$pkg_name"
    if [[ ! -d $pkg_dir ]]; then
        print_error "Package '$pkg_name' not found"
        return 1
    fi

    print_verbose "Installing package: $pkg_name"
    cd "$TERMUX_ROOT" && ./start-builder.sh ./build-package.sh "$pkg_name" >/dev/null
    if [[ $? -eq 0 ]]; then
        print_success "Package '$pkg_name' installed successfully"
    else
        print_error "Failed to install package '$pkg_name'"
    fi
}

function list_packages() {
    read_cache
}

function uninstall_package() {
    local pkg_name="$1"
    if [[ -z $pkg_name ]]; then
        print_error "Package name is required for uninstallation"
        return 1
    fi

    local pkg_dir="$TERMUX_ROOT/packages/$pkg_name"
    if [[ ! -d $pkg_dir ]]; then
        print_error "Package '$pkg_name' not found"
        return 1
    fi

    print_verbose "Uninstalling package: $pkg_name"
    rm -rf "$pkg_dir"
    print_success "Package '$pkg_name' uninstalled"
}

function upgrade_system() {
    print_verbose "Upgrading system..."
    pkg update && pkg upgrade -y
    print_success "System upgraded"
}

# --- Command Handling ---
command="$1"
shift

case $command in
install)
    install_package "$@"
    ;;
list)
    list_packages
    ;;
add)
    add_repository "$@"
    ;;
repos)
    list_repositories
    ;;
cache)
    cache_packages
    ;;
clean)
    clean_cache
    ;;
uninstall)
    uninstall_package "$@"
    ;;
upgrade)
    upgrade_system
    ;;
*)
    echo -e "${CYAN}Usage:${RESET} expkg <command> [options]"
    echo -e "${CYAN}Commands:${RESET}"
    echo -e "  ${GREEN}install <package>${RESET}     Install a package"
    echo -e "  ${GREEN}list${RESET}                  List cached packages"
    echo -e "  ${GREEN}add <repo_url>${RESET}        Add a custom repository"
    echo -e "  ${GREEN}repos${RESET}                 List custom repositories"
    echo -e "  ${GREEN}cache${RESET}                 Refresh package cache"
    echo -e "  ${GREEN}clean${RESET}                 Clear package cache"
    echo -e "  ${GREEN}uninstall <package>${RESET}   Uninstall a package"
    echo -e "  ${GREEN}upgrade${RESET}               Upgrade the system"
    ;;
esac
